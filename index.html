<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PyleaMUN Data Organizer</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #E8EAE6; color: #333; }
        .hidden { display: none !important; }
        .letterhead { display: flex; justify-content: space-between; align-items: center; background-color: #D6DBD2; border-bottom: 2px solid #444; padding: 10px 20px; min-height: 100px; flex-wrap: wrap; }
        .address, .contact { width: 30%; font-size: 0.9rem; }
        .contact { display: flex; flex-direction: column; align-items: flex-end; }
        .logo-container { width: 120px; text-align: center; }
        .logo { width: 120px; height: auto; }
        .letterhead a { color: #0066cc; text-decoration: none; }
        main { padding: 2em; max-width: 1000px; margin: auto; }
        h1, h2 { text-align: center; color: #005b63; }
        .container { background: #e0f7fa; padding: 2em; border-radius: 16px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        textarea { width: 100%; height: 180px; padding: 0.7em; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; box-sizing: border-box; font-family: monospace; }
        .hint { font-size: .9em; color:#066; margin-top:.4rem }
        .button-group { display: flex; justify-content: center; gap: 10px; margin: 1.5em 0; flex-wrap: wrap; }
        .btn { background-color: #00b4a0; color: white; font-size: 1em; padding: 0.8em 1.5em; border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; }
        .btn:hover { background-color: #00897b; }
        .btn.secondary { background-color: #00796b; }
        .btn.danger { background-color: #d32f2f; }
        .btn.export { background-color: #1e88e5; }
        .btn.print { background-color: #4CAF50; padding: 0.4em 0.8em; font-size: 0.9em; margin-left: 15px; }
        .btn.cleanup { background-color: #ff9800; }
        #status { text-align: center; font-weight: bold; color: #004d40; margin-top: 1em; min-height: 24px; }
        #output h3 { color: #00796b; border-bottom: 2px solid #b2dfdb; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center;}
        #output ul { list-style-type: none; padding-left: 0; }
        #output li { padding: 5px 0; }
        .advisor-info { background-color: #d0e8e6; border-radius: 8px; padding: 10px; margin: 5px 0 15px 0; font-size: 0.9em; }
        .report { background:#fff; border-radius:12px; padding:1rem; box-shadow:0 4px 12px rgba(0,0,0,.08); margin-top:1rem }
        .report h4 { margin:.2rem 0 .6rem; color:#005b63 }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace }
        .small { font-size:.9em }
        
        /* Table Styles for Advisor View */
        table.advisor-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        table.advisor-table th, table.advisor-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.9em; }
        table.advisor-table th { background-color: #00796b; color: white; }
        table.advisor-table tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <div id="app-container" class="hidden">
        <div class="letterhead">
            <div class="address"><strong>4 Isminis Str.</strong><br>Pylaia, Thessaloniki - 55535</div>
            <div class="logo-container"><img src="https://pyleamun.github.io/interview-guide/pyleaMUNfinallogo_transparent.png" alt="PyleaMUN Logo" class="logo"></div>
            <div class="contact">
                <div>+30 2310329199</div>
                <div><a href="mailto:pyleamun@gmail.com">pyleamun@gmail.com</a></div>
                <div><a href="https://pyleamun.github.io/pyleamun2026/" target="_blank">pyleamun.github.io/pyleamun2026</a></div>
            </div>
        </div>
        <main>
            <h1>PyleaMUN Delegations Organizer</h1>
            <div class="container">
                <h2>Paste Form Submission or PDF Text Below</h2>
                <textarea id="rawDataInput" placeholder="Paste the raw text from Formsubmit OR paste the text you copy from a 'PyleaMUN Delegate List' PDF (Ctrl/Cmd+A → Ctrl/Cmd+C) ..."></textarea>
                <div class="hint">Tip: To apply country re-allocations from a committee PDF (e.g., “PyleaMUN Delegate List – NATO ”), paste its text above and click <em>Apply PDF/Text Allocations</em>.</div>
                <div class="button-group">
                    <button id="processBtn" class="btn">Process Data</button>
                    <button id="addSingleBtn" class="btn secondary">Add Single Delegate</button>
                </div>
                <div id="status"></div>
                
                <div id="controls" class="button-group" style="display: none;">
                    <button class="btn secondary" onclick="displayByCommittee()">View by Committee</button>
                    <button class="btn secondary" onclick="displayByCountry()">View by Country</button>
                    <button class="btn secondary" onclick="displayBySchool()">View by School</button>
                    <button class="btn secondary" onclick="viewAdvisorsList()">View Advisors Table</button>

                    <button class="btn secondary" style="background-color: #2c3e50;" onclick="bulkManageAdvisors()">Add / Edit School Advisors</button>
                    <button class="btn secondary" onclick="editDelegateInfo()">Edit Delegate</button>
                    <button class="btn secondary" onclick="editSchoolName()">Edit School Name</button>
                    <button class="btn secondary" onclick="editCountryName()">Edit Country Name</button>
                    <button class="btn secondary" onclick="editCommitteeName()">Edit Committee Name</button>
                    <button class="btn secondary" onclick="bulkRenameDelegate()">Bulk Rename Delegate</button>
                    <button class="btn cleanup" onclick="fixAllCountryCases()">Fix All Country Cases</button>
                    <button class="btn secondary" onclick="applyPdfAllocations()" title="Paste PDF text above first">Apply PDF/Text Allocations</button>
                    
                    <button class="btn danger" onclick="handleClearDuplicates()">Clear Duplicates</button>
                    <button class="btn danger" onclick="deleteSchool()">Delete School</button>
                    <button class="btn danger" onclick="clearAllData()">Clear All Data</button>
                    <button class="btn danger" onclick="removeSingleDelegate()">Delete Delegate by Name</button>
                </div>
                
                <div id="output"></div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Surface runtime errors
        window.addEventListener('error', function (ev) {
            try {
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('status').textContent = ' Error: ' + (ev.message || 'Unknown script error');
            } catch (_) {}
        });

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBeEVJ9eu-pVhK_z3ds8UurrqaBeBBDwN4",
            authDomain: "pyleamun-data.firebaseapp.com",
            databaseURL: "https://pyleamun-data-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pyleamun-data",
            storageBucket: "pyleamun-data.appspot.com",
            messagingSenderId: "586095551075",
            appId: "1:586095551075:web:56d0e723275843d6dc4e56"
        };

        // *** COMMITTEE MAPPING ***
        const COMMITTEE_MAP = {
            "UNEP": "UN Environment Programme",
            "SC": "Security Council",
            "ECOSOC": "Economic & Social Council",
            "NATO": "NATO",
            "WHO": "World Health Organisation",
            "HRC": "Human Rights Council",
            "UNESCO": "UNESCO",
            "UN Women": "UN Women",
            "HCC": "Historical Crisis Committee",
            "UN": "UN Women"
        };

        const COMMITTEE_ALIASES = {
            "Security Council": "SC",
            "UN Environment Programme": "UNEP",
            "Economic & Social Council": "ECOSOC",
            "World Health Organisation": "WHO",
            "Human Rights Council": "HRC",
            "UNESCO": "UNESCO",
            "UN Women": "UN Women",
            "Historical Crisis Committee": "HCC",
            "NATO": "NATO"
        };

        const HCC_COUNTRY_MAPPED_NAME = COMMITTEE_MAP["HCC"];
        const HCC_COUNTRY_VALUE = "City State of (to be communicated shortly)";
        const COUNTRY_ACRONYMS = ["USA", "UK"]; 

        // --- INITIALIZATION ---
        let database, delegatesRef;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            delegatesRef = database.ref('delegates');
        } catch (e) {
            console.error('Firebase init error:', e);
        }
        let allDelegates = [];

        function initializeApp() {
            document.getElementById('app-container').classList.remove('hidden');
            if (!delegatesRef) {
                document.getElementById('status').textContent = ' Firebase not initialized. Check config or network.';
                return;
            }
            delegatesRef.on('value', snapshot => {
                const data = snapshot.val();
                allDelegates = [];
                if (data) {
                    const committeeUpdates = {};
                    for (const key in data) {
                        const d = data[key] || {};
                        const normalizedCommittee = normalizeCommitteeName(d.committee);

                        allDelegates.push({
                            ...d,
                            committee: normalizedCommittee,
                            firebaseKey: key
                        });

                        if (delegatesRef && normalizedCommittee && d.committee !== normalizedCommittee) {
                            committeeUpdates[`${key}/committee`] = normalizedCommittee;
                        }
                    }
                    if (delegatesRef && Object.keys(committeeUpdates).length) {
                        delegatesRef.update(committeeUpdates).catch(err => console.error('Committee normalization update failed:', err));
                    }
                }
                updateUI();
                const outputDiv = document.getElementById('output');
                if (outputDiv.innerHTML.includes('<h2>')) {
                    if (outputDiv.querySelector('h2').textContent.includes('School')) displayBySchool();
                    else if (outputDiv.querySelector('h2').textContent.includes('Committee')) displayByCommittee();
                    else if (outputDiv.querySelector('h2').textContent.includes('Country')) displayByCountry();
                }
            });
        }

        function updateUI() {
            const controlsEl = document.getElementById('controls');
            const uniqueSchools = [...new Set(allDelegates.map(d => d.school))];
            const schoolCount = uniqueSchools.length;
            document.getElementById('status').innerHTML =
                `Total delegates: <b>${allDelegates.length}</b> | Schools: <b>${schoolCount}</b>`;
            controlsEl.style.display = allDelegates.length > 0 ? 'flex' : 'none';
        }

        document.getElementById('processBtn').addEventListener('click', handleProcessData);
        document.getElementById('addSingleBtn').addEventListener('click', addSingleDelegate);

        // --- DATA PROCESSING ---
        function handleProcessData() {
            const rawDataInput = document.getElementById('rawDataInput');
            if (!rawDataInput.value.trim()) {
                document.getElementById('status').textContent = " Please paste data into the text box.";
                return;
            }
            const parsedData = parseRawData(rawDataInput.value);
            if (parsedData) {
                const newDelegates = structureDelegateData(parsedData);
                if (newDelegates && newDelegates.length > 0) {
                    let addedCount = 0;
                    const promises = newDelegates.map(delegate =>
                        delegatesRef.push(delegate).then(() => addedCount++)
                    );
                    Promise.all(promises).then(() => {
                         document.getElementById('status').textContent = ` Added ${addedCount} delegates for "${toSentenceCase(parsedData.School || 'Unknown School')}".`;
                         rawDataInput.value = '';
                         document.getElementById('output').innerHTML = '';
                    }).catch(error => {
                         document.getElementById('status').textContent = ` Error saving: ${error.message}`;
                    });
                } else {
                     document.getElementById('status').textContent = ` No delegate data found.`;
                }
            } else {
                document.getElementById('status').textContent = " Error parsing data.";
            }
        }

        function addSingleDelegate() {
            const name = prompt("Enter Delegate's Full Name (e.g., John Smith):");
            if (!name) return;
            const school = prompt("Enter School Name (e.g., Athens College):");
            if (!school) return;
            const committeeShort = prompt("Enter Committee Short Code (e.g., SC, WHO, UNEP):").toUpperCase();
            if (!committeeShort) return;
            let country = prompt("Enter Country/Topic Represented:");
            if (!country) return;

            const processedName = toSentenceCase(name);
            const processedSchool = toSentenceCase(school);
            let processedCountry = formatCountryName(country);
            if (committeeShort === "HCC") {
                processedCountry = HCC_COUNTRY_VALUE;
                alert(`Committee is HCC. Country/Topic set to: ${processedCountry}`);
            }

            // Ask for 3 Advisors
            const adv1e = prompt("Advisor 1 Email (optional):") || '';
            const adv1m = prompt("Advisor 1 Mobile (optional):") || '';
            const adv2e = prompt("Advisor 2 Email (optional):") || '';
            const adv2m = prompt("Advisor 2 Mobile (optional):") || '';
            const adv3e = prompt("Advisor 3 Email (optional):") || '';
            const adv3m = prompt("Advisor 3 Mobile (optional):") || '';

            const mappedCommittee = normalizeCommitteeName(COMMITTEE_MAP[committeeShort] || committeeShort);

            const delegateObject = {
                name: processedName,
                school: processedSchool,
                committee: mappedCommittee,
                country: processedCountry,
                advisor1_email: adv1e, advisor1_mobile: adv1m,
                advisor2_email: adv2e, advisor2_mobile: adv2m,
                advisor3_email: adv3e, advisor3_mobile: adv3m
            };

            delegatesRef.push(delegateObject)
                .then(() => document.getElementById('status').textContent = ` Added ${processedName}.`)
                .catch(error => document.getElementById('status').textContent = ` Error: ${error.message}`);
        }

        // *** BULK MANAGE ADVISORS (3 ADVISORS) ***
        function bulkManageAdvisors() {
            const schoolNameInput = prompt("Enter the School Name to manage advisors for:").trim();
            if (!schoolNameInput) return;

            const schoolNameNormalized = toSentenceCase(schoolNameInput);
            const targetDelegates = allDelegates.filter(d => toSentenceCase(d.school) === schoolNameNormalized);

            if (targetDelegates.length === 0) {
                document.getElementById('status').textContent = ` Error: No delegates found for "${schoolNameNormalized}".`;
                return;
            }

            const current = targetDelegates[0];
            const infoMsg = `Found ${targetDelegates.length} delegates for "${schoolNameNormalized}".\n` +
                            `Update advisor info below (Clear text to delete, Leave as-is to keep).`;

            if (!confirm(infoMsg)) return;

            const newAdv1Email = prompt("Advisor 1 Email:", current.advisor1_email || "") || "";
            const newAdv1Mobile = prompt("Advisor 1 Mobile:", current.advisor1_mobile || "") || "";
            
            const newAdv2Email = prompt("Advisor 2 Email:", current.advisor2_email || "") || "";
            const newAdv2Mobile = prompt("Advisor 2 Mobile:", current.advisor2_mobile || "") || "";

            const newAdv3Email = prompt("Advisor 3 Email:", current.advisor3_email || "") || "";
            const newAdv3Mobile = prompt("Advisor 3 Mobile:", current.advisor3_mobile || "") || "";

            const updates = {};
            let updateCount = 0;

            targetDelegates.forEach(d => {
                updates[`${d.firebaseKey}/advisor1_email`] = newAdv1Email;
                updates[`${d.firebaseKey}/advisor1_mobile`] = newAdv1Mobile;
                updates[`${d.firebaseKey}/advisor2_email`] = newAdv2Email;
                updates[`${d.firebaseKey}/advisor2_mobile`] = newAdv2Mobile;
                updates[`${d.firebaseKey}/advisor3_email`] = newAdv3Email;
                updates[`${d.firebaseKey}/advisor3_mobile`] = newAdv3Mobile;
                updateCount++;
            });

            delegatesRef.update(updates)
                .then(() => {
                    alert(`Success! Updated 3 advisors for ${schoolNameNormalized}.`);
                    document.getElementById('status').textContent = ` Updated advisor info for ${schoolNameNormalized}.`;
                })
                .catch(error => console.error(error));
        }

        // *** VIEW ADVISORS LIST (3 ADVISORS) ***
        function viewAdvisorsList() {
            const grouped = groupBy(allDelegates, 'school');
            const sortedSchools = Object.keys(grouped).sort((a, b) => a.localeCompare(b));
            
            let html = `<h2>Advisors Contact List</h2>`;
            html += `<p style="text-align:center; color:#666;">Showing contact info for ${sortedSchools.length} schools.</p>`;
            html += `<table class="advisor-table">
                        <thead>
                            <tr>
                                <th>School</th>
                                <th>Advisor 1</th>
                                <th>Advisor 2</th>
                                <th>Advisor 3</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            sortedSchools.forEach(school => {
                const d = grouped[school][0];
                html += `<tr>
                            <td><strong>${school}</strong></td>
                            <td>${d.advisor1_email || ''}<br>${d.advisor1_mobile || ''}</td>
                            <td>${d.advisor2_email || ''}<br>${d.advisor2_mobile || ''}</td>
                            <td>${d.advisor3_email || ''}<br>${d.advisor3_mobile || ''}</td>
                         </tr>`;
            });
            
            html += `</tbody></table>`;
            document.getElementById('output').innerHTML = html;
        }

        // --- APPLY PDF ALLOCATIONS ---
        function applyPdfAllocations() {
            const raw = document.getElementById('rawDataInput').value;
            if (!raw.trim()) {
                document.getElementById('status').textContent = " Paste the PDF or text content above, then try again.";
                return;
            }
            const { committeeShort, assignments } = parsePdfDelegateList(raw);
            if (!assignments || assignments.length === 0) {
                document.getElementById('status').textContent = " Couldn't detect 'Name (School) - Representing: Country' patterns.";
                return;
            }

            const targetCommitteeName = committeeShort ? normalizeCommitteeName(COMMITTEE_MAP[committeeShort] || committeeShort) : null;
            const index = {};
            allDelegates.forEach(d => {
                const key = `${toSentenceCase(d.name)}::${toSentenceCase(d.school)}`;
                if (!index[key]) index[key] = [];
                index[key].push(d);
            });

            const updates = {};
            const changedDelegates = [];
            const movedCommittee = [];
            const unchanged = [];
            const notFound = [];

            assignments.forEach(a => {
                const nameNorm = toSentenceCase(a.name.trim());
                const schoolNorm = toSentenceCase(a.school.trim());
                const key = `${nameNorm}::${schoolNorm}`;
                const matches = index[key];

                if (!matches || matches.length === 0) {
                    notFound.push(`${nameNorm} (${schoolNorm}) → ${a.country}`);
                    return;
                }

                let newCountry = formatCountryName(a.country.trim());
                if (committeeShort === 'HCC') newCountry = HCC_COUNTRY_VALUE;

                matches.forEach(d => {
                    const paths = {};
                    if ((d.country || '') !== newCountry) paths[`${d.firebaseKey}/country`] = newCountry;
                    if (targetCommitteeName && d.committee !== targetCommitteeName) paths[`${d.firebaseKey}/committee`] = targetCommitteeName;

                    const deltaKeys = Object.keys(paths);
                    if (deltaKeys.length > 0) {
                        deltaKeys.forEach(p => { updates[p] = paths[p]; });
                        changedDelegates.push(`${nameNorm} (${schoolNorm}) → ${newCountry}${targetCommitteeName ? ` [${targetCommitteeName}]` : ''}`);
                        if (paths[`${d.firebaseKey}/committee`]) movedCommittee.push(`${nameNorm} to ${targetCommitteeName}`);
                    } else {
                        unchanged.push(`${nameNorm}`);
                    }
                });
            });

            if (Object.keys(updates).length === 0) {
                document.getElementById('status').textContent = ` No changes necessary.`;
                renderAllocationReport({ committeeShort, targetCommitteeName, changedDelegates, movedCommittee, notFound, unchanged });
                return;
            }

            if (!confirm(`Apply ${Object.keys(updates).length} updates?`)) return;

            delegatesRef.update(updates)
                .then(() => {
                    document.getElementById('status').textContent = ` Applied updates.`;
                    renderAllocationReport({ committeeShort, targetCommitteeName, changedDelegates, movedCommittee, notFound, unchanged });
                })
                .catch(err => console.error(err));
        }

        function renderAllocationReport({ committeeShort, targetCommitteeName, changedDelegates, movedCommittee, notFound, unchanged }) {
            const out = document.getElementById('output');
            let html = '<div class="report">';
            html += `<h4>Allocation Sync Report ${targetCommitteeName ? `— <span class="small">${targetCommitteeName}</span>` : ''}</h4>`;
            if (changedDelegates.length) {
                html += `<p><b>${changedDelegates.length}</b> updated:</p><ul class="mono">`;
                changedDelegates.forEach(x => html += `<li>${escapeHtml(x)}</li>`);
                html += `</ul>`;
            }
            if (movedCommittee.length) {
                html += `<p><b>${movedCommittee.length}</b> moved committee:</p><ul class="mono">`;
                movedCommittee.forEach(x => html += `<li>${escapeHtml(x)}</li>`);
                html += `</ul>`;
            }
            if (notFound.length) {
                html += `<p><b>${notFound.length}</b> not found in DB:</p><ul class="mono">`;
                notFound.forEach(x => html += `<li>${escapeHtml(x)}</li>`);
                html += `</ul>`;
            }
            html += '</div>';
            out.innerHTML = html;
        }

        function parsePdfDelegateList(text) {
            const committeeShort = detectCommitteeShort(text);
            let flat = text.replace(/\r\n/g, '\n').replace(/\s+/g, ' ').trim().replace(/[–—]/g, '-');
            const assignments = [];
            let re = /(?:\b\d+\.\s*)?([A-Za-zÀ-ÖØ-öø-ÿ'’.\- ]+?)\s*\((.+?)\)\s*-\s*Representing:\s*([A-Za-zÀ-ÖØ-öø-ÿ'’.\- ]+?)(?=\s+\d+\.|$)/gmi;
            let m;
            while ((m = re.exec(flat)) !== null) {
                assignments.push({ name: m[1].trim(), school: m[2].trim(), country: m[3].trim() });
            }
            if (assignments.length === 0) {
                re = /([A-Za-zÀ-ÖØ-öø-ÿ'’.\- ]+?)\s*\((.+?)\)\s*-\s*Representing:\s*([A-Za-zÀ-ÖØ-öø-ÿ'’.\- ]+)/gmi;
                while ((m = re.exec(flat)) !== null) {
                    assignments.push({ name: m[1].trim(), school: m[2].trim(), country: m[3].trim() });
                }
            }
            return { committeeShort, assignments };
        }

        function detectCommitteeShort(text) {
            for (const short of Object.keys(COMMITTEE_MAP)) {
                if (new RegExp(`\\b${escapeRegExp(short)}\\b`, 'i').test(text)) return short;
            }
            for (const longName of Object.keys(COMMITTEE_ALIASES)) {
                if (new RegExp(escapeRegExp(longName), 'i').test(text)) return COMMITTEE_ALIASES[longName];
            }
            return null;
        }
        function escapeRegExp(str) { return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
        function escapeHtml(str) { return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

        // *** EDIT DELEGATE (3 ADVISORS) ***
        function editDelegateInfo() {
            const targetName = prompt("Enter Delegate's FULL NAME to find:");
            if (!targetName) return;
            const targetSchool = prompt(`Enter School Name for "${targetName}":`);
            if (!targetSchool) return;

            const normalizedTargetName = toSentenceCase(targetName);
            const normalizedTargetSchool = toSentenceCase(targetSchool);

            const delegateToEdit = allDelegates.find(d =>
                toSentenceCase(d.name) === normalizedTargetName &&
                toSentenceCase(d.school) === normalizedTargetSchool
            );

            if (!delegateToEdit) {
                alert(`Delegate not found.`);
                return;
            }

            const key = delegateToEdit.firebaseKey;

            const newName = prompt("Enter NEW Name:", delegateToEdit.name) || delegateToEdit.name;
            const newSchool = prompt("Enter NEW School:", delegateToEdit.school) || delegateToEdit.school;
            const currentShort = Object.keys(COMMITTEE_MAP).find(k => COMMITTEE_MAP[k] === delegateToEdit.committee) || delegateToEdit.committee;
            const newCommitteeInput = (prompt("Enter NEW Committee Code:", currentShort) || currentShort).toUpperCase();
            let newCountry = prompt("Enter NEW Country:", delegateToEdit.country) || delegateToEdit.country;

            const processedNewName = toSentenceCase(newName);
            const processedNewSchool = toSentenceCase(newSchool);
            let processedNewCountry = formatCountryName(newCountry);

            const adv1e = prompt("Advisor 1 Email:", delegateToEdit.advisor1_email) || delegateToEdit.advisor1_email;
            const adv1m = prompt("Advisor 1 Mobile:", delegateToEdit.advisor1_mobile) || delegateToEdit.advisor1_mobile;
            const adv2e = prompt("Advisor 2 Email:", delegateToEdit.advisor2_email) || delegateToEdit.advisor2_email;
            const adv2m = prompt("Advisor 2 Mobile:", delegateToEdit.advisor2_mobile) || delegateToEdit.advisor2_mobile;
            const adv3e = prompt("Advisor 3 Email:", delegateToEdit.advisor3_email) || delegateToEdit.advisor3_email;
            const adv3m = prompt("Advisor 3 Mobile:", delegateToEdit.advisor3_mobile) || delegateToEdit.advisor3_mobile;

            const newMappedCommittee = normalizeCommitteeName(COMMITTEE_MAP[newCommitteeInput] || newCommitteeInput);

            const updatedObj = {
                name: processedNewName,
                school: processedNewSchool,
                committee: newMappedCommittee,
                country: processedNewCountry,
                advisor1_email: adv1e, advisor1_mobile: adv1m,
                advisor2_email: adv2e, advisor2_mobile: adv2m,
                advisor3_email: adv3e, advisor3_mobile: adv3m
            };

            database.ref('delegates/' + key).update(updatedObj)
                .then(() => document.getElementById('status').textContent = ` Updated ${processedNewName}.`)
                .catch(error => console.error(error));
        }

        // --- OTHER EDITS (Existing) ---
        function editSchoolName() {
            const oldName = prompt("Current School Name:");
            if (!oldName) return;
            const newName = prompt(`New School Name for "${oldName}":`);
            if (!newName) return;

            const oldNorm = toSentenceCase(oldName);
            const newNorm = toSentenceCase(newName);
            
            database.ref('delegates').once('value').then(snapshot => {
                const updates = {};
                let count = 0;
                snapshot.forEach(child => {
                    if (toSentenceCase(child.val().school) === oldNorm && child.val().school !== newNorm) {
                        updates[`${child.key}/school`] = newNorm;
                        count++;
                    }
                });
                if (count > 0 && confirm(`Update ${count} delegates?`)) {
                    delegatesRef.update(updates).then(() => document.getElementById('status').textContent = ` Updated school names.`);
                } else {
                    document.getElementById('status').textContent = ` No updates needed or cancelled.`;
                }
            });
        }

        function editCountryName() {
            const oldName = prompt("Current Country Name:");
            if (!oldName) return;
            const newName = prompt(`New Country Name for "${oldName}":`);
            if (!newName) return;

            const oldSearch = oldName.toLowerCase();
            database.ref('delegates').once('value').then(snapshot => {
                const updates = {};
                let count = 0;
                snapshot.forEach(child => {
                    const d = child.val();
                    if (d.country && d.country.toLowerCase() === oldSearch && d.country !== newName) {
                        updates[`${child.key}/country`] = newName;
                        count++;
                    }
                });
                if (count > 0 && confirm(`Update ${count} delegates?`)) {
                    delegatesRef.update(updates).then(() => document.getElementById('status').textContent = ` Updated country names.`);
                }
            });
        }

        function editCommitteeName() {
            const oldName = prompt("Current Committee Name (exact):");
            if (!oldName) return;
            const newName = prompt(`New Committee Name for "${oldName}":`);
            if (!newName) return;

            database.ref('delegates').once('value').then(snapshot => {
                const updates = {};
                let count = 0;
                snapshot.forEach(child => {
                    if (child.val().committee === oldName) {
                        updates[`${child.key}/committee`] = newName;
                        count++;
                    }
                });
                if (count > 0 && confirm(`Update ${count} delegates?`)) {
                    delegatesRef.update(updates).then(() => document.getElementById('status').textContent = ` Updated committees.`);
                }
            });
        }

        function bulkRenameDelegate() {
            const oldName = prompt("Current full name:");
            if (!oldName) return;
            const school = prompt("School:");
            if (!school) return;
            const newName = prompt("New name:");
            if (!newName) return;

            const oldNorm = toSentenceCase(oldName);
            const schoolNorm = toSentenceCase(school);
            const newNorm = toSentenceCase(newName);

            const updates = {};
            let count = 0;
            allDelegates.forEach(d => {
                if (toSentenceCase(d.name) === oldNorm && toSentenceCase(d.school) === schoolNorm) {
                    updates[`${d.firebaseKey}/name`] = newNorm;
                    count++;
                }
            });
            if (count > 0 && confirm(`Rename ${count} records?`)) {
                delegatesRef.update(updates).then(() => document.getElementById('status').textContent = ` Renamed.`);
            }
        }

        // --- DELETIONS ---
        function removeSingleDelegate() {
            const name = prompt("Name to delete:");
            if (!name) return;
            const school = prompt("School:");
            if (!school) return;
            const dToDelete = allDelegates.find(d => toSentenceCase(d.name) === toSentenceCase(name) && toSentenceCase(d.school) === toSentenceCase(school));
            if (dToDelete && confirm(`Delete ${dToDelete.name}?`)) {
                database.ref('delegates/' + dToDelete.firebaseKey).remove();
            }
        }

        function deleteSchool() {
            const school = prompt("School to delete (ALL delegates):");
            if (!school) return;
            const schoolNorm = toSentenceCase(school);
            const toDelete = allDelegates.filter(d => toSentenceCase(d.school) === schoolNorm);
            if (toDelete.length > 0 && confirm(`Delete ${toDelete.length} delegates from ${schoolNorm}?`)) {
                const updates = {};
                toDelete.forEach(d => updates[d.firebaseKey] = null);
                delegatesRef.update(updates);
            }
        }

        function clearAllData() {
            if (confirm("Permanently delete ALL data?")) delegatesRef.remove();
        }

        function handleClearDuplicates() {
            if (!confirm("Delete duplicates?")) return;
            delegatesRef.once('value', snapshot => {
                const data = snapshot.val();
                if (!data) return;
                const map = {};
                const toDel = [];
                for (const key in data) {
                    const d = data[key];
                    const u = `${toSentenceCase(d.name)}::${toSentenceCase(d.school)}::${normalizeCommitteeName(d.committee)}`.toLowerCase();
                    if (map[u]) toDel.push(key);
                    else map[u] = key;
                }
                const promises = toDel.map(k => delegatesRef.child(k).remove());
                Promise.all(promises).then(() => document.getElementById('status').textContent = ` Removed ${toDel.length} duplicates.`);
            });
        }

        // --- HELPERS ---
        function structureDelegateData(parsedData) {
            const delegates = [];
            const schoolName = toSentenceCase(parsedData["School"] || "N/A");
            const c1 = formatCountryName(parsedData["Country 1"] || "N/A");
            const c2 = formatCountryName(parsedData["Country 2"] || "N/A");

            // Parser only sees 2 advisors in raw text, 3rd can be added via Edit/Bulk buttons
            const schoolInfo = {
                school: schoolName,
                advisor1_email: parsedData["First Advisor’s personal e-mail"] || "",
                advisor1_mobile: parsedData["First Advisor’s mobile number"] || "",
                advisor2_email: parsedData["Second Advisor’s personal e-mail"] || "",
                advisor2_mobile: parsedData["Second Advisor’s mobile number"] || ""
            };

            for (const key in parsedData) {
                let delegateName = parsedData[key];
                if (delegateName && typeof delegateName === 'string' && key.includes("Country") && !["Country 1", "Country 2"].includes(key)) {
                    delegateName = toSentenceCase(delegateName);
                    const parts = key.split(" ");
                    const committeeShort = parts[0];
                    const countryNum = parts[2];
                    const mappedCommittee = normalizeCommitteeName(COMMITTEE_MAP[committeeShort] || committeeShort);
                    let countryValue = countryNum === "1" ? c1 : c2;
                    if (committeeShort === "HCC") countryValue = HCC_COUNTRY_VALUE;

                    delegates.push({
                        name: delegateName,
                        school: schoolInfo.school,
                        committee: mappedCommittee,
                        country: countryValue,
                        advisor1_email: schoolInfo.advisor1_email,
                        advisor1_mobile: schoolInfo.advisor1_mobile,
                        advisor2_email: schoolInfo.advisor2_email,
                        advisor2_mobile: schoolInfo.advisor2_mobile,
                        advisor3_email: "", advisor3_mobile: "" // Initialize empty
                    });
                }
            }
            return delegates;
        }

        function normalizeHCCCountry(d) { return (d && d.country === HCC_COUNTRY_VALUE) ? HCC_COUNTRY_VALUE : (d ? d.country : ""); }
        function cleanText(str) {
            // Remove emoji/symbol ranges + invisible characters that can cause "duplicate" committee names (e.g., NATO vs NATO\u200B)
            return str ? String(str)
                .replace(/[\u200B-\u200D\uFEFF]/g, '')        // zero-width chars
                .replace(/\u00A0/g, ' ')                        // NBSP → space
                .replace(/[\u2010-\u2015]/g, '-')              // normalize dashes
                .replace(/[\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF]/g, '')
                .trim()
            : "";
        }
        function normalizeCommitteeName(name) {
            if (!name) return "";
            const cleaned = cleanText(String(name)).replace(/\s+/g, ' ').trim();

            // Canonicalize to avoid duplicates caused by punctuation/spacing/spelling variants
            const canonical = cleaned.toLowerCase().replace(/[^a-z0-9]/g, '');

            const CANONICAL_COMMITTEE = {
                unep: "UN Environment Programme",
                unenvironprogramme: "UN Environment Programme",
                unenvironprogram: "UN Environment Programme",

                sc: "Security Council",
                securitycouncil: "Security Council",

                ecosoc: "Economic & Social Council",
                economicandsocialcouncil: "Economic & Social Council",

                nato: "NATO",
                northatlantictreatyorganization: "NATO",
                northatlantictreatyorganisation: "NATO",

                who: "World Health Organisation",
                worldhealthorganisation: "World Health Organisation",
                worldhealthorganization: "World Health Organisation",

                hrc: "Human Rights Council",
                humanrightscouncil: "Human Rights Council",

                unesco: "UNESCO",

                unwomen: "UN Women",
                un: "UN Women",

                hcc: "Historical Crisis Committee",
                historicalcrisiscommittee: "Historical Crisis Committee"
            };

            if (CANONICAL_COMMITTEE[canonical]) return CANONICAL_COMMITTEE[canonical];

            const upper = cleaned.toUpperCase();
            if (COMMITTEE_MAP[cleaned]) return COMMITTEE_MAP[cleaned];
            if (COMMITTEE_MAP[upper]) return COMMITTEE_MAP[upper];

            if (/^UN\s*WOMEN$/i.test(cleaned) || /^UN$/i.test(cleaned)) return "UN Women";
            for (const k in COMMITTEE_MAP) if (COMMITTEE_MAP[k].toLowerCase() === cleaned.toLowerCase()) return COMMITTEE_MAP[k];
            return cleaned;
        }
        function toSentenceCase(str) { return str ? str.trim().toLowerCase().replace(/\b\w/g, c => c.toUpperCase()).replace(/\bOf\b/gi, 'of') : ""; }
        function formatCountryName(c) { 
            if (!c) return "N/A";
            return COUNTRY_ACRONYMS.includes(c.trim().toUpperCase()) ? c.trim().toUpperCase() : toSentenceCase(c.trim());
        }
        function parseRawData(raw) {
            let txt = raw.replace(/’s_/g, "’s ").replace(/_/g, " ");
            if (txt.includes("Here's what they had to say:")) txt = txt.split("Here's what they had to say:")[1];
            if (txt.includes("Submitted at")) txt = txt.split("Submitted at")[0];
            txt = txt.trim();
            const FIELDS = ["School", "First Advisor’s personal e-mail", "First Advisor’s mobile number", "Second Advisor’s personal e-mail", "Second Advisor’s mobile number", "Number of Delegates", "Country 1", "Country 2", "UNEP Country 1", "UNEP Country 2", "SC Country 1", "SC Country 2", "ECOSOC Country 1", "ECOSOC Country 2", "NATO Country 1", "NATO Country 2", "WHO Country 1", "WHO Country 2", "HRC Country 1", "HRC Country 2", "UNESCO Country 1", "UNESCO Country 2", "UN Women Country 1", "UN Women Country 2", "HCC Country 1", "HCC Country 2", "Special Comments"];
            const found = [];
            FIELDS.forEach(f => {
                let pos = txt.indexOf(f);
                if (pos !== -1) found.push({ f, pos });
            });
            if (found.length === 0) return null;
            found.sort((a, b) => a.pos - b.pos);
            const parsed = {};
            for (let i = 0; i < found.length; i++) {
                const val = txt.substring(found[i].pos + found[i].f.length, found[i+1] ? found[i+1].pos : txt.length).trim();
                parsed[found[i].f] = val;
            }
            return parsed;
        }
        function groupBy(arr, key) {
            return arr.reduce((r, v) => { (r[v[key]] = r[v[key]] || []).push(v); return r; }, {});
        }

        // --- DISPLAY & PRINTING (3 ADVISORS) ---
        function displayBySchool() {
            const grouped = groupBy(allDelegates, 'school');
            let html = '<h2>Delegates by School</h2>';
            html += `<div class="button-group"><button class="btn export" onclick="exportBySchool()">Export this View</button></div>`;
            Object.keys(grouped).sort((a,b)=>a.localeCompare(b)).forEach(school => {
                const list = grouped[school];
                if (!list.length) return;
                const d = list[0];
                const esc = school.replace(/'/g, "\\'");
                html += `<h3><span>${school} (${list.length})</span><button class="btn print" onclick="printSchoolPDF('${esc}')">Print PDF</button></h3>`;
                html += `<div class="advisor-info">
                            <strong>Advisor 1:</strong> ${d.advisor1_email || '-'} | ${d.advisor1_mobile || '-'}<br>
                            <strong>Advisor 2:</strong> ${d.advisor2_email || '-'} | ${d.advisor2_mobile || '-'}<br>
                            <strong>Advisor 3:</strong> ${d.advisor3_email || '-'} | ${d.advisor3_mobile || '-'}
                         </div><ul>`;
                list.sort((a,b)=>a.name.localeCompare(b.name)).forEach((del, i) => {
                    html += `<li><strong>${i+1}.</strong> <b>${del.name}</b> - Committee: ${normalizeCommitteeName(del.committee)} (${normalizeHCCCountry(del)})</li>`;
                });
                html += '</ul>';
            });
            document.getElementById('output').innerHTML = html;
        }

        function displayByCommittee() {
            const grouped = groupBy(allDelegates, 'committee');
            let html = '<h2>Delegates by Committee</h2>';
            html += `<div class="button-group"><button class="btn export" onclick="exportByCommittee()">Export this View</button></div>`;
            Object.keys(grouped).sort((a,b)=>a.localeCompare(b)).forEach(comm => {
                const list = grouped[comm];
                if (!list.length) return;
                html += `<h3><span>${comm} (${list.length})</span><button class="btn print" onclick="printCommitteePDF('${comm.replace(/'/g,"\\'")}')">Print PDF</button></h3><ul>`;
                list.sort((a,b)=>a.name.localeCompare(b.name)).forEach((d, i) => {
                    html += `<li><strong>${i+1}.</strong> <b>${d.name}</b> (${d.school}) - Representing: ${normalizeHCCCountry(d)}</li>`;
                });
                html += '</ul>';
            });
            document.getElementById('output').innerHTML = html;
        }

        function displayByCountry() {
            const grouped = groupBy(allDelegates.map(d=>({...d, country: normalizeHCCCountry(d)})), 'country');
            let html = '<h2>Delegates by Country</h2>';
            html += `<div class="button-group"><button class="btn export" onclick="exportByCountry()">Export this View</button></div>`;
            Object.keys(grouped).sort((a,b)=>a.localeCompare(b)).forEach(c => {
                const list = grouped[c];
                if (!list.length) return;
                html += `<h3><span>${c} (${list.length})</span><button class="btn print" onclick="printCountryPDF('${c.replace(/'/g,"\\'")}')">Print PDF</button></h3><ul>`;
                list.sort((a,b)=>a.name.localeCompare(b.name)).forEach((d, i) => {
                    html += `<li><strong>${i+1}.</strong> <b>${d.name}</b> (${d.school}) - Committee: ${normalizeCommitteeName(d.committee)}</li>`;
                });
                html += '</ul>';
            });
            document.getElementById('output').innerHTML = html;
        }

        // --- EXPORT (3 ADVISORS) ---
        function exportBySchool() {
            const grouped = groupBy(allDelegates, 'school');
            let csv = "School,Adv1 Email,Adv1 Mobile,Adv2 Email,Adv2 Mobile,Adv3 Email,Adv3 Mobile,Delegate,Committee,Country\n";
            Object.keys(grouped).sort((a,b)=>a.localeCompare(b)).forEach(school => {
                grouped[school].sort((a,b)=>a.name.localeCompare(b.name)).forEach(d => {
                    const row = [d.school, d.advisor1_email, d.advisor1_mobile, d.advisor2_email, d.advisor2_mobile, d.advisor3_email, d.advisor3_mobile, d.name, normalizeCommitteeName(d.committee), normalizeHCCCountry(d)];
                    csv += row.map(v => `"${(v||"").replace(/"/g, '""')}"`).join(",") + "\n";
                });
            });
            downloadCsv(csv, "delegates_by_school.csv");
        }
        function exportByCommittee() {
            const grouped = groupBy(allDelegates, 'committee');
            let csv = "Committee,Name,School,Country\n";
            Object.keys(grouped).sort((a,b)=>a.localeCompare(b)).forEach(c => {
                grouped[c].sort((a,b)=>a.name.localeCompare(b.name)).forEach(d => {
                    csv += [normalizeCommitteeName(d.committee), d.name, d.school, normalizeHCCCountry(d)].map(v => `"${(v||"").replace(/"/g, '""')}"`).join(",") + "\n";
                });
            });
            downloadCsv(csv, "delegates_by_committee.csv");
        }
        function exportByCountry() {
            const grouped = groupBy(allDelegates.map(d=>({...d,country:normalizeHCCCountry(d)})), 'country');
            let csv = "Country,Name,School,Committee\n";
            Object.keys(grouped).sort((a,b)=>a.localeCompare(b)).forEach(c => {
                grouped[c].sort((a,b)=>a.name.localeCompare(b.name)).forEach(d => {
                    csv += [cleanText(d.country), d.name, d.school, normalizeCommitteeName(d.committee)].map(v => `"${(v||"").replace(/"/g, '""')}"`).join(",") + "\n";
                });
            });
            downloadCsv(csv, "delegates_by_country.csv");
        }
        function downloadCsv(csv, fn) {
            const link = document.createElement("a");
            link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
            link.download = fn;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- PRINTING (3 ADVISORS) ---
        function generatePrintHTML(title, subTitle, listItemsHtml, includeAdvisorInfo = false, d = null) {
             let advisorHtml = '';
             if (includeAdvisorInfo && d) {
                 advisorHtml = `<div class="advisor-info">
                     <strong>Advisor 1:</strong> ${d.advisor1_email || 'N/A'} | ${d.advisor1_mobile || 'N/A'}<br>
                     <strong>Advisor 2:</strong> ${d.advisor2_email || 'N/A'} | ${d.advisor2_mobile || 'N/A'}<br>
                     <strong>Advisor 3:</strong> ${d.advisor3_email || 'N/A'} | ${d.advisor3_mobile || 'N/A'}
                 </div>`;
             }
             return `<html><head><title>PyleaMUN</title><style>
                    body{font-family:'Segoe UI',sans-serif;margin:20mm}
                    .print-logo{width:100px;display:block;margin:0 auto 20px auto}
                    h1{text-align:center;color:#005b63;font-size:1.4em}h2{text-align:center;color:#00796b;margin-bottom:20px}
                    .advisor-info{border:1px solid #ccc;background-color:#f0f8f7;padding:10px;margin:15px 0;font-size:0.9em}
                    ul{list-style:none;padding:0}li{padding:4px 0;border-bottom:1px dotted #eee;font-size:0.95em}
                    @media print{body{margin:0}.advisor-info{background-color:#f0f8f7!important;-webkit-print-color-adjust:exact}}
                </style></head><body>
                    <img src="https://pyleamun.github.io/interview-guide/pyleaMUNfinallogo_transparent.png" class="print-logo">
                    <h1>${title}</h1><h2>${subTitle}</h2>${advisorHtml}<ul>${listItemsHtml}</ul></body></html>`;
        }

        function printSchoolPDF(schoolName) {
            const list = allDelegates.filter(d => d.school === schoolName);
            if (!list.length) return alert("No delegates.");
            list.sort((a,b)=>a.name.localeCompare(b.name));
            let html = '';
            list.forEach((d, i) => html += `<li><strong>${i+1}.</strong> <b>${d.name}</b> - Committee: ${normalizeCommitteeName(d.committee)} (${normalizeHCCCountry(d)})</li>`);
            const win = window.open('','_blank');
            win.document.write(generatePrintHTML("PyleaMUN Delegate List", schoolName, html, true, list[0]));
            win.document.close();
            win.focus();
            setTimeout(() => win.print(), 500);
        }
        function printCommitteePDF(name) {
            const list = allDelegates.filter(d => d.committee === name);
            if (!list.length) return alert("No delegates.");
            list.sort((a,b)=>a.name.localeCompare(b.name));
            let html = '';
            list.forEach((d, i) => html += `<li><strong>${i+1}.</strong> <b>${d.name}</b> (${d.school}) - Representing: ${normalizeHCCCountry(d)}</li>`);
            const win = window.open('','_blank');
            win.document.write(generatePrintHTML("PyleaMUN Delegate List", name, html, false));
            win.document.close();
            win.focus();
            setTimeout(() => win.print(), 500);
        }
        function printCountryPDF(name) {
            const list = allDelegates.filter(d => normalizeHCCCountry(d) === name);
            if (!list.length) return alert("No delegates.");
            list.sort((a,b)=>a.name.localeCompare(b.name));
            let html = '';
            list.forEach((d, i) => html += `<li><strong>${i+1}.</strong> <b>${d.name}</b> (${d.school}) - Committee: ${normalizeCommitteeName(d.committee)}</li>`);
            const win = window.open('','_blank');
            win.document.write(generatePrintHTML("PyleaMUN Delegate List", `Country: ${name}`, html, false));
            win.document.close();
            win.focus();
            setTimeout(() => win.print(), 500);
        }
        function fixAllCountryCases() {
            if (!confirm("Fix all country cases?")) return;
            database.ref('delegates').once('value').then(snapshot => {
                const updates = {};
                let c = 0;
                snapshot.forEach(child => {
                    const d = child.val();
                    if (!d.country || d.committee === HCC_COUNTRY_MAPPED_NAME || d.country === HCC_COUNTRY_VALUE) return;
                    const correct = formatCountryName(d.country);
                    if (d.country !== correct) { updates[`${child.key}/country`] = correct; c++; }
                });
                if (c > 0) delegatesRef.update(updates).then(() => document.getElementById('status').textContent = ` Fixed ${c} countries.`);
                else document.getElementById('status').textContent = " No fixes needed.";
            });
        }

        initializeApp();
    </script>
</body>
</html>
