<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PyleaMUN Data Organizer</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        /* --- 1. CSS VARIABLES & RESET --- */
        :root {
            --primary: #005b63;
            --secondary: #00796b;
            --accent: #00b4a0;
            --bg-body: #E8EAE6;
            --bg-panel: #e0f7fa;
            --text-main: #333;
            --danger: #d32f2f;
            --success: #2e7d32;
            --warning: #ff9800;
        }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: var(--bg-body); color: var(--text-main); }
        *, *::before, *::after { box-sizing: border-box; }
        
        .hidden { display: none !important; }

        /* --- 2. HEADER & LAYOUT --- */
        .letterhead { display: flex; justify-content: space-between; align-items: center; background-color: #D6DBD2; border-bottom: 2px solid #444; padding: 10px 20px; min-height: 100px; flex-wrap: wrap; }
        .address, .contact { width: 30%; font-size: 0.9rem; }
        .contact { display: flex; flex-direction: column; align-items: flex-end; }
        .logo-container { width: 120px; text-align: center; }
        .logo { width: 120px; height: auto; }
        .letterhead a { color: #0066cc; text-decoration: none; }

        main { padding: 2em; max-width: 1100px; margin: auto; }
        h1 { text-align: center; color: var(--primary); margin-bottom: 0.5em; }
        h2 { color: var(--secondary); margin-top: 0; }

        .panel { background: var(--bg-panel); padding: 2em; border-radius: 12px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        
        /* --- 3. INPUTS & BUTTONS --- */
        textarea { width: 100%; height: 150px; padding: 1em; border-radius: 8px; border: 1px solid #ccc; font-family: monospace; font-size: 0.9rem; resize: vertical; }
        .hint { font-size: 0.85em; color: var(--primary); margin-top: 0.5rem; font-style: italic; }

        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 1.5em 0; padding-bottom: 1.5em; border-bottom: 1px solid #b2dfdb; }
        
        .btn { 
            background-color: var(--accent); color: white; border: none; 
            padding: 0.6em 1.2em; border-radius: 20px; cursor: pointer; 
            font-size: 0.9em; font-weight: 600; transition: filter 0.2s; 
            display: inline-flex; align-items: center; gap: 5px;
        }
        .btn:hover { filter: brightness(90%); }
        .btn.primary { background-color: var(--primary); font-size: 1em; padding: 0.8em 2em; }
        .btn.danger { background-color: var(--danger); }
        .btn.warning { background-color: var(--warning); color: #333; }
        .btn.excel { background-color: #2e7d32; } /* Excel Green */
        .btn.pdf { background-color: #d32f2f; }   /* PDF Red */

        /* --- 4. OUTPUT AREA --- */
        #status { text-align: center; font-weight: bold; margin: 1em 0; min-height: 1.5em; color: var(--primary); }
        
        .result-group { margin-bottom: 20px; page-break-inside: avoid; }
        .result-group h3 { 
            color: var(--secondary); 
            border-bottom: 2px solid #b2dfdb; 
            padding-bottom: 5px; 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: 1.5em;
        }
        
        .advisor-box { background-color: #d0e8e6; border-radius: 6px; padding: 8px 12px; font-size: 0.85em; margin-bottom: 10px; }
        
        ul.data-list { list-style: none; padding: 0; }
        ul.data-list li { padding: 4px 0; border-bottom: 1px dotted #ccc; }
        ul.data-list li:last-child { border-bottom: none; }

        .report-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 15px; }

        /* --- 5. PDF EXPORT STYLES (Hidden from screen, visible to generator) --- */
        #pdf-container { display: none; } 
    </style>
</head>
<body>

    <div id="app-container" class="hidden">
        <div class="letterhead">
            <div class="address"><strong>4 Isminis Str.</strong><br>Pylaia, Thessaloniki - 55535</div>
            <div class="logo-container">
                <img src="https://pyleamun.github.io/interview-guide/pyleaMUNfinallogo_transparent.png" alt="Logo" class="logo">
            </div>
            <div class="contact">
                <div>üìû +30 2310329199</div>
                <div>üìß <a href="mailto:pyleamun@gmail.com">pyleamun@gmail.com</a></div>
                <div>üåê <a href="https://pyleamun.github.io/pyleamun2026/" target="_blank">pyleamun.github.io</a></div>
            </div>
        </div>

        <main>
            <h1>üèõÔ∏è PyleaMUN Delegations Organizer</h1>
            
            <div class="panel">
                <h2>Data Input</h2>
                <textarea id="rawDataInput" placeholder="Paste data here (Formsubmit email text OR PDF text)..."></textarea>
                <div class="hint">Tip: Paste text from 'PyleaMUN Delegate List ‚Äì Committee' PDF to apply re-allocations.</div>
                
                <div class="toolbar">
                    <button id="btnProcess" class="btn primary">üì• Process Raw Data</button>
                    <button id="btnAddSingle" class="btn primary">üë§ Add Single Delegate</button>
                    <button id="btnSyncPdf" class="btn warning" title="Paste PDF text above first">üîÑ Apply PDF/Text Allocations</button>
                </div>

                <div id="status"></div>

                <div id="controls" class="toolbar hidden">
                    <button class="btn" onclick="App.renderView('committee')">View by Committee</button>
                    <button class="btn" onclick="App.renderView('country')">View by Country</button>
                    <button class="btn" onclick="App.renderView('school')">View by School</button>
                    
                    <button class="btn" onclick="App.editSingleDelegate()">Edit Delegate</button>
                    <button class="btn danger" onclick="App.deleteSingleDelegate()">Delete Delegate</button>
                    
                    <button class="btn" onclick="App.bulkEdit('school')">Rename School</button>
                    <button class="btn" onclick="App.bulkEdit('country')">Rename Country</button>
                    <button class="btn" onclick="App.bulkEdit('committee')">Rename Committee</button>
                    <button class="btn" onclick="App.bulkEdit('delegateName')">Bulk Rename Delegate</button>
                    
                    <button class="btn warning" onclick="App.fixAllCountryCases()">Fix Capitalization</button>
                    <button class="btn danger" onclick="App.clearDuplicates()">Clear Duplicates</button>
                    <button class="btn danger" onclick="App.deleteSchool()">Delete School</button>
                    <button class="btn danger" onclick="App.nukeDatabase()">‚ö†Ô∏è Clear All Data</button>
                </div>

                <div id="output"></div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        /**
         * ==========================================
         * 1. CONFIGURATION & CONSTANTS
         * ==========================================
         */
        const Config = {
            passwords: {
                organizer: "329199p",
                admin: "panos26@"
            },
            firebase: {
                apiKey: "AIzaSyBeEVJ9eu-pVhK_z3ds8UurrqaBeBBDwN4",
                authDomain: "pyleamun-data.firebaseapp.com",
                databaseURL: "https://pyleamun-data-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "pyleamun-data",
                storageBucket: "pyleamun-data.appspot.com",
                messagingSenderId: "586095551075",
                appId: "1:586095551075:web:56d0e723275843d6dc4e56"
            },
            committees: {
                map: {
                    "UNEP": "UN Environment Programme üå±",
                    "SC": "Security Council üîê",
                    "ECOSOC": "Economic & Social Council üí∞",
                    "NATO": "NATO üõ°Ô∏è",
                    "WHO": "World Health Organisation üè•",
                    "HRC": "Human Rights Council ü§ù",
                    "UNESCO": "UNESCO üìö",
                    "UN Women": "UN Women üë©‚öñÔ∏è",
                    "HCC": "Historical Crisis Committee ‚è≥",
                    "UN": "UN Women üë©‚öñÔ∏è"
                }
            },
            specialValues: {
                hccPlaceholder: "City State of (to be communicated shortly)",
                upperCaseCountries: ["USA", "UK"]
            }
        };

        /**
         * ==========================================
         * 2. UTILITIES
         * ==========================================
         */
        const Utils = {
            toSentenceCase: (str) => {
                if (!str) return "";
                return str.trim().toLowerCase().replace(/\b\w/g, c => c.toUpperCase()).replace(/\bOf\b/gi, 'of');
            },
            formatCountry: (str) => {
                if (!str) return "N/A";
                const clean = str.trim();
                if (Config.specialValues.upperCaseCountries.includes(clean.toUpperCase())) return clean.toUpperCase();
                return Utils.toSentenceCase(clean);
            },
            normalizeHCC: (delegate) => {
                if (delegate.committee === Config.committees.map["HCC"]) return Config.specialValues.hccPlaceholder;
                return delegate.country;
            },
            groupBy: (arr, key) => arr.reduce((acc, obj) => { (acc[obj[key]] = acc[obj[key]] || []).push(obj); return acc; }, {}),
            requireAuth: (level, callback) => {
                const targetPwd = level === 'admin' ? Config.passwords.admin : Config.passwords.organizer;
                const stored = sessionStorage.getItem('pyleamun-auth');
                if (stored === Config.passwords.organizer || stored === Config.passwords.admin) {
                    if (level === 'admin' && stored !== Config.passwords.admin) {} else { callback(); return; }
                }
                const input = prompt(`Enter ${level.toUpperCase()} password:`);
                if (input === targetPwd || (level === 'organizer' && input === Config.passwords.admin)) {
                    sessionStorage.setItem('pyleamun-auth', input);
                    callback();
                } else if (input) alert("‚ùå Incorrect password.");
            }
        };

        /**
         * ==========================================
         * 3. DATABASE SERVICE
         * ==========================================
         */
        const DB = {
            ref: null, data: [],
            init: () => {
                try {
                    firebase.initializeApp(Config.firebase);
                    DB.ref = firebase.database().ref('delegates');
                    DB.ref.on('value', (snapshot) => {
                        const val = snapshot.val();
                        DB.data = [];
                        if (val) for (const key in val) DB.data.push({ ...val[key], firebaseKey: key });
                        App.updateStatus();
                    });
                } catch (e) { document.getElementById('status').innerText = "‚ùå Database Connection Failed"; }
            },
            add: (d) => DB.ref.push(d),
            update: (u) => DB.ref.update(u),
            remove: (k) => DB.ref.child(k).remove(),
            nuke: () => DB.ref.remove()
        };

        /**
         * ==========================================
         * 4. MAIN APP LOGIC
         * ==========================================
         */
        const App = {
            init: () => {
                DB.init();
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('btnProcess').onclick = App.processRawInput;
                document.getElementById('btnAddSingle').onclick = App.addSingleDelegate;
                document.getElementById('btnSyncPdf').onclick = App.syncPdfAllocations;
            },
            updateStatus: () => {
                const schools = new Set(DB.data.map(d => d.school)).size;
                document.getElementById('status').innerHTML = `Delegates: <b>${DB.data.length}</b> | Schools: <b>${schools}</b>`;
                if(DB.data.length > 0) document.getElementById('controls').classList.remove('hidden');
            },
            processRawInput: () => {
                const raw = document.getElementById('rawDataInput').value;
                if (!raw.trim()) return alert("Paste data first!");
                const parsed = Parsers.parseFormSubmit(raw);
                if (!parsed) return alert("‚ùå Could not parse format.");
                const delegates = Parsers.structureData(parsed);
                if (delegates.length === 0) return alert("‚ö†Ô∏è No delegates found.");
                Promise.all(delegates.map(d => DB.add(d)))
                    .then(() => {
                        document.getElementById('status').innerText = `‚úÖ Added ${delegates.length} delegates from ${parsed.School}`;
                        document.getElementById('rawDataInput').value = "";
                        document.getElementById('output').innerHTML = "";
                    }).catch(e => alert("Error: " + e.message));
            },
            addSingleDelegate: () => {
                const name = prompt("Full Name:"); if (!name) return;
                const school = prompt("School:");
                const commShort = prompt("Committee Code (SC, WHO, etc):").toUpperCase();
                let country = prompt("Country/Topic:");
                if (commShort === "HCC") { country = Config.specialValues.hccPlaceholder; alert("Set to HCC placeholder topic."); }
                DB.add({
                    name: Utils.toSentenceCase(name), school: Utils.toSentenceCase(school),
                    committee: Config.committees.map[commShort] || commShort, country: Utils.formatCountry(country),
                    advisor1_email: "", advisor1_mobile: "", advisor2_email: "", advisor2_mobile: ""
                }).then(() => alert(`‚úÖ Added ${name}`));
            },
            renderView: (mode) => {
                const container = document.getElementById('output');
                container.innerHTML = "";
                let html = "";
                
                // DATA PREP
                const dataset = DB.data.map(d => ({ ...d, displayCountry: Utils.normalizeHCC(d) }));
                const grouped = Utils.groupBy(dataset, mode === 'delegateName' ? 'school' : mode);
                const keys = Object.keys(grouped).sort();

                // BUILD HTML
                let title = mode === 'school' ? "üè´ Delegates by School" : (mode === 'committee' ? "üìã Delegates by Committee" : "üåç Delegates by Country");
                html += `<h2>${title}</h2>`;
                
                // EXPORT BUTTONS
                html += `<div style="text-align:center; margin-bottom:20px; display:flex; gap:10px; justify-content:center;">
                            <button class="btn excel" onclick="Exporter.excel('${mode}')">üìä Download Excel</button>
                            <button class="btn pdf" onclick="Exporter.pdf('${mode}')">üìÑ Download PDF</button>
                         </div>`;

                keys.forEach(key => {
                    const list = grouped[key];
                    const first = list[0];
                    let advisors = mode === 'school' ? (first.advisor1_email ? `<b>Adv:</b> ${first.advisor1_email} ${first.advisor1_mobile}` : '') : '';
                    
                    html += `<div class="result-group">
                        <h3>${key} <span style="font-size:0.8em">(${list.length})</span></h3>
                        ${advisors ? `<div class="advisor-box">${advisors}</div>` : ''}
                        <ul class="data-list">`;
                    
                    list.sort((a,b) => a.name.localeCompare(b.name)).forEach((d, i) => {
                        let text = mode === 'school' 
                            ? `<b>${d.name}</b> ‚Äî ${d.committee} (${d.displayCountry})`
                            : `<b>${d.name}</b> (${d.school}) ‚Äî ${mode==='committee' ? d.displayCountry : d.committee}`;
                        html += `<li>${i+1}. ${text}</li>`;
                    });
                    html += `</ul></div>`;
                });
                container.innerHTML = html;
            },
            // EDITING FUNCTIONS
            bulkEdit: (field) => {
                Utils.requireAuth('organizer', () => {
                    if(field === 'delegateName') { App.bulkRenameDelegate(); return; }
                    const oldVal = prompt(`Enter CURRENT ${field} name:`); if (!oldVal) return;
                    const newVal = prompt(`Enter NEW ${field} name:`); if (!newVal) return;
                    const updates = {}; let count = 0;
                    DB.data.forEach(d => {
                        if (d[field] && d[field].toLowerCase() === oldVal.trim().toLowerCase()) {
                            if(field === 'country' && d.committee === Config.committees.map['HCC']) return;
                            updates[`${d.firebaseKey}/${field}`] = field === 'country' ? Utils.formatCountry(newVal) : Utils.toSentenceCase(newVal);
                            count++;
                        }
                    });
                    if (count > 0 && confirm(`Update ${count} records?`)) DB.update(updates).then(() => alert(`‚úÖ Updated ${count} records.`));
                });
            },
            bulkRenameDelegate: () => {
                const oldName = prompt("Current Name:"); const school = prompt("School (filter):");
                if(!oldName || !school) return;
                const newName = prompt("New Name:");
                const updates = {}; let count = 0;
                DB.data.forEach(d => {
                    if(d.name.toLowerCase() === oldName.toLowerCase() && d.school.toLowerCase() === school.toLowerCase()) {
                        updates[`${d.firebaseKey}/name`] = Utils.toSentenceCase(newName); count++;
                    }
                });
                if(count > 0) DB.update(updates).then(() => alert("Renamed."));
            },
            editSingleDelegate: () => {
                Utils.requireAuth('organizer', () => {
                    const name = prompt("Name to Edit:"); if(!name) return;
                    const targets = DB.data.filter(d => d.name.toLowerCase().includes(name.toLowerCase()));
                    if(targets.length === 0) return alert("Not found.");
                    if(targets.length > 1) return alert(`Found ${targets.length} matches.`);
                    const target = targets[0];
                    const newName = prompt("Name:", target.name) || target.name;
                    const newSchool = prompt("School:", target.school) || target.school;
                    const newCountry = prompt("Country:", target.country) || target.country;
                    DB.update({
                        [`${target.firebaseKey}/name`]: newName,
                        [`${target.firebaseKey}/school`]: newSchool,
                        [`${target.firebaseKey}/country`]: newCountry
                    }).then(() => alert("Updated."));
                });
            },
            deleteSingleDelegate: () => {
                Utils.requireAuth('admin', () => {
                    const name = prompt("Name to DELETE:"); const school = prompt("School:");
                    const target = DB.data.find(d => d.name.toLowerCase() === name.toLowerCase() && d.school.toLowerCase() === school.toLowerCase());
                    if(target && confirm(`Delete ${target.name}?`)) DB.remove(target.firebaseKey).then(() => alert("Deleted."));
                });
            },
            deleteSchool: () => {
                Utils.requireAuth('admin', () => {
                    const school = prompt("School Name to DELETE:"); if(!school) return;
                    const targets = DB.data.filter(d => d.school.toLowerCase() === school.toLowerCase());
                    if(targets.length > 0 && confirm(`Delete ${targets.length} delegates from ${school}?`)) {
                        const updates = {}; targets.forEach(t => updates[t.firebaseKey] = null);
                        DB.update(updates).then(() => alert("School deleted."));
                    }
                });
            },
            fixAllCountryCases: () => {
                Utils.requireAuth('admin', () => {
                    if(!confirm("Normalize all country capitalizations?")) return;
                    const updates = {}; let count = 0;
                    DB.data.forEach(d => {
                        if(d.committee === Config.committees.map['HCC']) return;
                        const correct = Utils.formatCountry(d.country);
                        if(d.country !== correct) { updates[`${d.firebaseKey}/country`] = correct; count++; }
                    });
                    if(count > 0) DB.update(updates).then(() => alert(`Fixed ${count} countries.`));
                });
            },
            clearDuplicates: () => {
                Utils.requireAuth('admin', () => {
                    if(!confirm("Scan and delete duplicates?")) return;
                    const seen = {}; const toDelete = {}; let count = 0;
                    DB.data.forEach(d => {
                        const key = `${d.name}-${d.school}-${d.committee}`.toLowerCase();
                        if(seen[key]) { toDelete[d.firebaseKey] = null; count++; } else { seen[key] = true; }
                    });
                    if(count > 0) DB.update(toDelete).then(() => alert(`Removed ${count} duplicates.`));
                });
            },
            nukeDatabase: () => {
                Utils.requireAuth('admin', () => { if(confirm("DANGER: DELETE ALL DATA?")) DB.nuke().then(() => location.reload()); });
            },
            syncPdfAllocations: () => {
                Utils.requireAuth('organizer', () => {
                    const raw = document.getElementById('rawDataInput').value; if(!raw.trim()) return alert("Paste PDF text.");
                    const result = Parsers.parsePdfText(raw); if(result.assignments.length === 0) return alert("No valid lines found.");
                    const updates = {}; const log = []; const dbMap = {};
                    DB.data.forEach(d => { const k = `${d.name.toLowerCase()}|${d.school.toLowerCase()}`; if(!dbMap[k]) dbMap[k]=[]; dbMap[k].push(d); });
                    result.assignments.forEach(assign => {
                        const matches = dbMap[`${assign.name.toLowerCase()}|${assign.school.toLowerCase()}`];
                        if(matches) matches.forEach(d => {
                            let newCountry = Utils.formatCountry(assign.country);
                            if(result.committeeShort === 'HCC') newCountry = Config.specialValues.hccPlaceholder;
                            const newComm = result.committeeShort ? (Config.committees.map[result.committeeShort] || result.committeeShort) : null;
                            if(d.country !== newCountry) { updates[`${d.firebaseKey}/country`] = newCountry; log.push(`${d.name}: Country -> ${newCountry}`); }
                            if(newComm && d.committee !== newComm) { updates[`${d.firebaseKey}/committee`] = newComm; log.push(`${d.name}: Committee -> ${newComm}`); }
                        });
                    });
                    if(log.length > 0) {
                        if(confirm(`Apply ${log.length} updates?`)) DB.update(updates).then(() => alert("Updates applied."));
                    } else alert("All matched delegates are up to date.");
                });
            }
        };

        /**
         * ==========================================
         * 5. EXPORTER (PDF & EXCEL)
         * ==========================================
         */
        const Exporter = {
            excel: (mode) => {
                // Prepare Data
                const dataset = DB.data.map(d => ({
                    "Name": d.name,
                    "School": d.school,
                    "Committee": d.committee,
                    "Country": Utils.normalizeHCC(d),
                    "Advisor 1": `${d.advisor1_email} ${d.advisor1_mobile}`.trim(),
                    "Advisor 2": `${d.advisor2_email} ${d.advisor2_mobile}`.trim()
                }));
                
                // Sort
                if(mode === 'school') dataset.sort((a,b) => a.School.localeCompare(b.School) || a.Name.localeCompare(b.Name));
                else if(mode === 'committee') dataset.sort((a,b) => a.Committee.localeCompare(b.Committee) || a.Name.localeCompare(b.Name));
                else dataset.sort((a,b) => a.Country.localeCompare(b.Country) || a.Name.localeCompare(b.Name));

                // Create Workbook
                const ws = XLSX.utils.json_to_sheet(dataset);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Delegates");
                
                // Save File
                XLSX.writeFile(wb, `PyleaMUN_Export_${mode}.xlsx`);
            },

            pdf: (mode) => {
                const element = document.getElementById('output');
                if(!element || element.innerHTML === "") return alert("Please click a View button first.");
                
                const opt = {
                    margin:       10,
                    filename:     `PyleaMUN_Report_${mode}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                // Use html2pdf library
                html2pdf().set(opt).from(element).save();
            }
        };

        /**
         * ==========================================
         * 6. PARSERS
         * ==========================================
         */
        const Parsers = {
            parseFormSubmit: (text) => {
                let clean = text.replace(/‚Äôs_/g, "‚Äôs ").replace(/_/g, " ");
                if (clean.includes("Here's what they had to say:")) clean = clean.split("Here's what they had to say:")[1];
                if (clean.includes("Submitted at")) clean = clean.split("Submitted at")[0];
                clean = clean.trim();
                const regexMap = {
                    School: /School\s+([\s\S]+?)(?=First Advisor|$)/i,
                    Adv1Email: /First Advisor‚Äôs personal e-mail\s+([\s\S]+?)(?=First Advisor‚Äôs mobile|$)/i,
                    Adv1Mob: /First Advisor‚Äôs mobile number\s+([\s\S]+?)(?=Second|$)/i,
                    Adv2Email: /Second Advisor‚Äôs personal e-mail\s+([\s\S]+?)(?=Second Advisor‚Äôs mobile|$)/i,
                    Adv2Mob: /Second Advisor‚Äôs mobile number\s+([\s\S]+?)(?=Number of Delegates|$)/i,
                    C1: /Country 1\s+([\s\S]+?)(?=Country 2|$)/i,
                    C2: /Country 2\s+([\s\S]+?)(?=UNEP|$)/i
                };
                const result = {}; for (const [key, rx] of Object.entries(regexMap)) { const m = clean.match(rx); if(m) result[key] = m[1].trim(); }
                if(!result.School) return null;
                result.allocations = {};
                const comms = ["UNEP", "SC", "ECOSOC", "NATO", "WHO", "HRC", "UNESCO", "UN Women", "HCC"];
                comms.forEach(c => {
                    const rx1 = new RegExp(`${c} Country 1\\s+([\\s\\S]+?)(?=${c} Country 2|$)`, 'i');
                    const rx2 = new RegExp(`${c} Country 2\\s+([\\s\\S]+?)(?=${comms.find(next=>text.indexOf(next)>text.indexOf(c))}|Special Comments|$)`, 'i');
                    const m1 = clean.match(rx1); const m2 = clean.match(rx2);
                    if(m1 && m1[1].trim()) result.allocations[`${c} 1`] = m1[1].trim();
                    if(m2 && m2[1].trim()) result.allocations[`${c} 2`] = m2[1].trim();
                });
                return result;
            },
            structureData: (parsed) => {
                const out = []; const school = Utils.toSentenceCase(parsed.School);
                const c1 = Utils.formatCountry(parsed.C1); const c2 = Utils.formatCountry(parsed.C2);
                for(const [key, name] of Object.entries(parsed.allocations)) {
                    const [commCode, num] = key.split(" ");
                    let country = (num === "1") ? c1 : c2;
                    let commFull = Config.committees.map[commCode] || commCode;
                    if(commCode === "HCC") country = Config.specialValues.hccPlaceholder;
                    if(commCode === "UN" || commCode === "UN Women") commFull = Config.committees.map["UN Women"];
                    out.push({
                        name: Utils.toSentenceCase(name), committee: commFull, country: country, school: school,
                        advisor1_email: parsed.Adv1Email||"", advisor1_mobile: parsed.Adv1Mob||"", advisor2_email: parsed.Adv2Email||"", advisor2_mobile: parsed.Adv2Mob||""
                    });
                }
                return out;
            },
            parsePdfText: (text) => {
                let flat = text.replace(/\r\n/g, '\n').replace(/\s+/g, ' ').replace(/[‚Äì‚Äî]/g, '-').trim();
                let detectedComm = null;
                for(const [short, full] of Object.entries(Config.committees.map)) { if(flat.includes(short) || flat.includes(full)) { detectedComm = short; break; } }
                const assignments = []; const regex = /([A-Za-z√Ä-√ø'‚Äô.\- ]+?)\s*\((.+?)\)\s*-\s*Representing:\s*([A-Za-z√Ä-√ø'‚Äô.\- ]+)/gmi;
                let m; while ((m = regex.exec(flat)) !== null) { assignments.push({ name: m[1].trim(), school: m[2].trim(), country: m[3].trim() }); }
                return { committeeShort: detectedComm, assignments };
            }
        };

        // --- BOOT ---
        window.addEventListener('DOMContentLoaded', () => { Utils.requireAuth('organizer', App.init); });
    </script>
</body>
</html>